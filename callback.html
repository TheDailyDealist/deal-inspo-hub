<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connecting to Pinterest...</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 600px; 
            margin: 50px auto; 
            text-align: center; 
            padding: 20px;
            color: #333;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: bold;
        }
        .loading { background-color: #eef; color: #3498db; border: 1px solid #3498db; }
        .error { background-color: #fee; color: #e60023; border: 1px solid #e60023; }
        .success { background-color: #efe; color: #28a745; border: 1px solid #28a745; }
        #boards-container {
            margin-top: 20px;
            text-align: left;
        }
        #boards-container h3 {
            text-align: center;
        }
        #boards-list {
            list-style-type: none;
            padding: 0;
        }
        #boards-list li {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 8px;
            border-left: 5px solid #bd081c;
        }
    </style>
</head>
<body>
    <h1>üîó Connecting to Pinterest</h1>
    <div id="status" class="loading">Processing authorization...</div>
    <div id="boards-container"></div>

    <script>
        const statusDiv = document.getElementById('status');
        const boardsContainer = document.getElementById('boards-container');

        // !!! –í–ê–ñ–ù–û: –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–£ –°–°–´–õ–ö–£ –ù–ê –í–ê–®–£ !!!
        const BACKEND_URL = 'https://exploreandbook-legal.netlify.app/.netlify/functions/pinterest-token';
        
        // 1. –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');

        // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∞ –∏–ª–∏ –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        if (error) {
            statusDiv.className = 'status error';
            statusDiv.textContent = `‚ùå Authorization failed: ${error}`;
        } else if (code) {
            statusDiv.className = 'status loading';
            statusDiv.textContent = '‚úÖ Code received. Exchanging for access token...';
            
            // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥ –Ω–∞ –Ω–∞—à –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –±—ç–∫–µ–Ω–¥
            exchangeCodeForToken(code);
        } else {
            statusDiv.className = 'status error';
            statusDiv.textContent = '‚ùå No authorization code found.';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–º–µ–Ω–∞ –∫–æ–¥–∞ –Ω–∞ —Ç–æ–∫–µ–Ω
        function exchangeCodeForToken(authCode) {
            fetch(BACKEND_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: authCode })
            })
            .then(response => {
                if (!response.ok) {
                    // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É, –ø—ã—Ç–∞–µ–º—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å –µ–µ
                    return response.json().then(err => Promise.reject(err));
                }
                return response.json();
            })
            .then(data => {
                if (data.access_token) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = 'üéâ Successfully connected! Fetching your boards...';
                    
                    // 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å–∫–∏
                    localStorage.setItem('pinterest_access_token', data.access_token);
                    fetchAndDisplayBoards(data.access_token);

                } else {
                    // –ï—Å–ª–∏ –≤ –æ—Ç–≤–µ—Ç–µ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞
                    throw new Error('Access token was not received.');
                }
            })
            .catch(err => {
                statusDiv.className = 'status error';
                const errorMessage = err.message || err.error_description || 'Unknown error during token exchange.';
                statusDiv.textContent = `‚ùå Error: ${errorMessage}`;
            });
        }

        // 5. –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ—Å–æ–∫
        function fetchAndDisplayBoards(accessToken) {
            boardsContainer.innerHTML = '<h3>Loading your boards...</h3>';

            fetch('https://api.pinterest.com/v5/boards', {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.items) {
                    let boardsHtml = '<h3>Your Pinterest Boards:</h3><ul id="boards-list">';
                    if (data.items.length > 0) {
                        data.items.forEach(board => {
                            boardsHtml += `<li>${board.name}</li>`;
                        });
                    } else {
                        boardsHtml += '<li>You have no boards yet.</li>';
                    }
                    boardsHtml += '</ul>';
                    boardsContainer.innerHTML = boardsHtml;
                } else {
                    throw new Error (data.message || 'Could not parse boards data.');
                }
            })
            .catch(err => {
                boardsContainer.innerHTML = `<p class="error">Failed to load boards: ${err.message}</p>`;
            });
        }
    </script>
</body>
</html>

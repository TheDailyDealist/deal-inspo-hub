<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connecting to Pinterest...</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 600px; 
            margin: 50px auto; 
            text-align: center; 
            padding: 20px;
            color: #333;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: bold;
        }
        .loading { background-color: #eef; color: #3498db; border: 1px solid #3498db; }
        .error { background-color: #fee; color: #e60023; border: 1px solid #e60023; }
        .success { background-color: #efe; color: #28a745; border: 1px solid #28a745; }
        #boards-container {
            margin-top: 20px;
            text-align: left;
        }
        #boards-container h3 {
            text-align: center;
        }
        #boards-list {
            list-style-type: none;
            padding: 0;
        }
        #boards-list li {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 8px;
            border-left: 5px solid #bd081c;
            cursor: pointer;
            transition: all 0.2s;
        }
        #boards-list li:hover {
            background: #ececec;
            transform: translateX(5px);
        }
        .board-name {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        .board-desc {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .board-stats {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>üéâ Deal Inspiration Hub</h1>
    <div id="status" class="loading">Connecting to your Pinterest account...</div>
    <div id="boards-container"></div>

    <script>
        const statusDiv = document.getElementById('status');
        const boardsContainer = document.getElementById('boards-container');

        // Backend URLs
        const TOKEN_URL = 'https://exploreandbook-legal.netlify.app/.netlify/functions/pinterest-token';
        const PROXY_URL = 'https://exploreandbook-legal.netlify.app/.netlify/functions/pinterest-proxy';
        
        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç Pinterest
        if (error) {
            statusDiv.className = 'status error';
            statusDiv.textContent = `‚ùå Authorization failed: ${error}`;
        } else if (code) {
            exchangeCodeForToken(code);
        } else {
            statusDiv.className = 'status error';
            statusDiv.textContent = '‚ùå No authorization code found.';
        }

        // –û–±–º–µ–Ω –∫–æ–¥–∞ –Ω–∞ —Ç–æ–∫–µ–Ω
        function exchangeCodeForToken(authCode) {
            fetch(TOKEN_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: authCode })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(err));
                }
                return response.json();
            })
            .then(data => {
                if (data.access_token) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = '‚úÖ Connected successfully! Loading your boards...';
                    
                    localStorage.setItem('pinterest_access_token', data.access_token);
                    
                    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è UX
                    setTimeout(() => {
                        fetchAndDisplayBoards(data.access_token);
                    }, 500);

                } else {
                    throw new Error('Could not connect to Pinterest. Please try again.');
                }
            })
            .catch(err => {
                statusDiv.className = 'status error';
                const errorMessage = err.error_description || err.message || 'Connection failed. Please try again.';
                statusDiv.textContent = `‚ùå ${errorMessage}`;
            });
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ—Å–æ–∫
        function fetchAndDisplayBoards(accessToken) {
            boardsContainer.innerHTML = '<h3>üìå Loading your Pinterest boards...</h3>';

            fetch(`${PROXY_URL}?endpoint=boards`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(err));
                }
                return response.json();
            })
            .then(data => {
                if (data.items) {
                    statusDiv.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞
                    
                    let boardsHtml = '<h3>üìå Your Pinterest Boards</h3><ul id="boards-list">';
                    
                    if (data.items.length > 0) {
                        data.items.forEach(board => {
                            boardsHtml += `
                                <li onclick="selectBoard('${board.id}', '${board.name}')">
                                    <div class="board-name">${board.name}</div>
                                    ${board.description ? `<div class="board-desc">${board.description}</div>` : ''}
                                    <div class="board-stats">
                                        ${board.pin_count || 0} pins ‚Ä¢ ${board.follower_count || 0} followers
                                    </div>
                                </li>
                            `;
                        });
                    } else {
                        boardsHtml += '<li>You don\'t have any boards yet. Create one on Pinterest!</li>';
                    }
                    
                    boardsHtml += '</ul>';
                    boardsContainer.innerHTML = boardsHtml;
                } else {
                    throw new Error('Could not load boards data.');
                }
            })
            .catch(err => {
                boardsContainer.innerHTML = `
                    <div class="status error">
                        Failed to load boards. Please refresh the page and try again.
                    </div>
                `;
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –¥–æ—Å–∫–∏ (–¥–ª—è –±—É–¥—É—â–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞)
        function selectBoard(boardId, boardName) {
            console.log(`Selected board: ${boardName} (${boardId})`);
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ—Ö–æ–¥ –∫ –ø—Ä–æ—Å–º–æ—Ç—Ä—É –ø–∏–Ω–æ–≤ –¥–æ—Å–∫–∏
            alert(`You selected: ${boardName}\n\nNext step: View pins from this board!`);
        }
    </script>
</body>
</html>

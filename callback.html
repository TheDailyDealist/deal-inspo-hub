<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connecting to Pinterest...</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 600px; 
            margin: 50px auto; 
            text-align: center; 
            padding: 20px;
            color: #333;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: bold;
        }
        .loading { background-color: #eef; color: #3498db; border: 1px solid #3498db; }
        .error { background-color: #fee; color: #e60023; border: 1px solid #e60023; }
        .success { background-color: #efe; color: #28a745; border: 1px solid #28a745; }
        #boards-container {
            margin-top: 20px;
            text-align: left;
        }
        #boards-container h3 {
            text-align: center;
        }
        #boards-list {
            list-style-type: none;
            padding: 0;
        }
        #boards-list li {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 8px;
            border-left: 5px solid #bd081c;
        }
        .debug {
            margin-top: 20px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            text-align: left;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>üîó Connecting to Pinterest</h1>
    <div id="status" class="loading">Processing authorization...</div>
    <div id="boards-container"></div>
    <div id="debug" class="debug"></div>

    <script>
        const statusDiv = document.getElementById('status');
        const boardsContainer = document.getElementById('boards-container');
        const debugDiv = document.getElementById('debug');

        // ‚úÖ URL –≤–∞—à–∏—Ö Netlify —Ñ—É–Ω–∫—Ü–∏–π
        const TOKEN_URL = 'https://exploreandbook-legal.netlify.app/.netlify/functions/pinterest-token';
        const PROXY_URL = 'https://exploreandbook-legal.netlify.app/.netlify/functions/pinterest-proxy';
        
        function addDebug(message) {
            const time = new Date().toLocaleTimeString();
            debugDiv.innerHTML += `[${time}] ${message}<br>`;
            console.log(message);
        }

        addDebug('üöÄ Script started');
        addDebug(`Token URL: ${TOKEN_URL}`);
        addDebug(`Proxy URL: ${PROXY_URL}`);

        // 1. –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');

        addDebug(`Code: ${code ? 'received' : 'missing'}`);
        addDebug(`Error: ${error || 'none'}`);

        // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∞ –∏–ª–∏ –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        if (error) {
            statusDiv.className = 'status error';
            statusDiv.textContent = `‚ùå Authorization failed: ${error}`;
            addDebug(`‚ùå Authorization error: ${error}`);
        } else if (code) {
            statusDiv.className = 'status loading';
            statusDiv.textContent = '‚úÖ Code received. Exchanging for access token...';
            addDebug('üì§ Sending code to backend...');
            
            // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥ –Ω–∞ –Ω–∞—à –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –±—ç–∫–µ–Ω–¥
            exchangeCodeForToken(code);
        } else {
            statusDiv.className = 'status error';
            statusDiv.textContent = '‚ùå No authorization code found.';
            addDebug('‚ùå No code in URL parameters');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–º–µ–Ω–∞ –∫–æ–¥–∞ –Ω–∞ —Ç–æ–∫–µ–Ω
        function exchangeCodeForToken(authCode) {
            addDebug(`üîÑ Calling TOKEN_URL with code...`);
            
            fetch(TOKEN_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: authCode })
            })
            .then(response => {
                addDebug(`üì• Token response status: ${response.status}`);
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(err));
                }
                return response.json();
            })
            .then(data => {
                addDebug(`‚úÖ Token received: ${data.access_token ? 'YES' : 'NO'}`);
                
                if (data.access_token) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = 'üéâ Successfully connected! Fetching your boards...';
                    
                    // 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å–∫–∏
                    localStorage.setItem('pinterest_access_token', data.access_token);
                    addDebug(`üíæ Token saved to localStorage`);
                    
                    fetchAndDisplayBoards(data.access_token);

                } else {
                    throw new Error('Access token was not received.');
                }
            })
            .catch(err => {
                statusDiv.className = 'status error';
                const errorMessage = err.message || err.error_description || 'Unknown error during token exchange.';
                statusDiv.textContent = `‚ùå Error: ${errorMessage}`;
                addDebug(`‚ùå Token exchange failed: ${errorMessage}`);
                console.error('Token exchange error:', err);
            });
        }

        // 5. –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ—Å–æ–∫ (–ß–ï–†–ï–ó –ü–†–û–ö–°–ò!)
        function fetchAndDisplayBoards(accessToken) {
            boardsContainer.innerHTML = '<h3>Loading your boards...</h3>';
            
            const proxyEndpoint = `${PROXY_URL}?endpoint=boards`;
            addDebug(`üîÑ Calling PROXY: ${proxyEndpoint}`);

            // ‚úÖ –¢–µ–ø–µ—Ä—å –∑–∞–ø—Ä–æ—Å –∏–¥–µ—Ç —á–µ—Ä–µ–∑ –≤–∞—à –±—ç–∫–µ–Ω–¥, –∞ –Ω–µ –Ω–∞–ø—Ä—è–º—É—é –∫ Pinterest
            fetch(proxyEndpoint, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => {
                addDebug(`üì• Boards response status: ${response.status}`);
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(err));
                }
                return response.json();
            })
            .then(data => {
                addDebug(`‚úÖ Boards data received: ${data.items ? data.items.length : 0} boards`);
                console.log('Boards data:', data);
                
                if (data.items) {
                    let boardsHtml = '<h3>üìå Your Pinterest Boards:</h3><ul id="boards-list">';
                    if (data.items.length > 0) {
                        data.items.forEach(board => {
                            boardsHtml += `<li><strong>${board.name}</strong><br><small>${board.description || 'No description'}</small></li>`;
                        });
                    } else {
                        boardsHtml += '<li>You have no boards yet.</li>';
                    }
                    boardsHtml += '</ul>';
                    boardsContainer.innerHTML = boardsHtml;
                    addDebug(`‚úÖ Boards displayed successfully`);
                } else {
                    throw new Error(data.message || 'Could not parse boards data.');
                }
            })
            .catch(err => {
                console.error('Boards fetch error:', err);
                const errorMsg = err.message || JSON.stringify(err) || 'Unknown error';
                boardsContainer.innerHTML = `<p class="error">Failed to load boards: ${errorMsg}</p>`;
                addDebug(`‚ùå Boards fetch failed: ${errorMsg}`);
            });
        }
    </script>
</body>
</html>
